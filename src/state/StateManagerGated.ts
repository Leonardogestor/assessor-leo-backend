import { pool } from '../config/database';

/**
 * Estados principais do fluxo com gates obrigat√≥rios
 */
export enum EstadoPrincipal {
  ENTRADA = 'ENTRADA',
  LUCIDEZ = 'LUCIDEZ',
  GATE_TERMO = 'GATE_TERMO',
  IMERSAO = 'IMERSAO',
  GATE_AUTORIZACAO = 'GATE_AUTORIZACAO',
  VISAO = 'VISAO',
  EXPERIENCIAS = 'EXPERIENCIAS'
}

/**
 * Estado do usu√°rio com gates e persist√™ncia
 */
export interface UserStateGated {
  user_id: string;
  phone_number: string;
  estado_atual: EstadoPrincipal;
  
  // Gates obrigat√≥rios
  accepted_terms: boolean;
  accepted_terms_at?: Date;
  authorized_analysis: boolean;
  authorized_analysis_at?: Date;
  
  // Dados coletados na imers√£o
  dados_coletados: {
    renda?: number;
    dividas?: number;
    gastos_mensais?: number;
    tem_prints?: boolean;
    tem_extratos?: boolean;
    sonho_principal?: string;
    maior_dor?: string;
  };
  
  // Controle de progress√£o
  interacoes: number;
  created_at: Date;
  updated_at: Date;
}

/**
 * System prompts din√¢micos por estado
 */
const BASE_PERSONALITY = `Voc√™ √© L√©o, um assessor financeiro que conduz pessoas √† liberdade financeira atrav√©s da consci√™ncia e da realiza√ß√£o de sonhos.

IDENTIDADE
Voc√™ √© acolhedor, direto, did√°tico e extremamente emp√°tico. Fala com firmeza suave, baseado em dados (nunca em opini√£o). Nunca julga, nunca acusa, nunca se coloca como superior. Seu √∫nico prop√≥sito √© resgatar os sonhos do cliente e gui√°-lo at√© eles.

LIMITES √âTICOS
- Voc√™ N√ÉO √© consultor de investimentos, advogado ou contador
- Voc√™ N√ÉO promete ganhos financeiros garantidos
- Voc√™ N√ÉO d√° conselhos irrespons√°veis
- Voc√™ N√ÉO encerra o atendimento (acompanhamento √© cont√≠nuo)

TOM DE VOZ
- Acolhedor mas firme
- Claro e simples (nunca rebuscado)
- Emp√°tico sem ser paternalista
- Motivador sem ser falso
- Maduro e estrat√©gico`;

const PROMPTS_POR_ESTADO: Record<EstadoPrincipal, string> = {
  [EstadoPrincipal.ENTRADA]: `${BASE_PERSONALITY}

INSTRU√á√ïES ESPEC√çFICAS - ESTADO ENTRADA:
- Esta √© a PRIMEIRA intera√ß√£o com o usu√°rio
- Seu objetivo: criar conex√£o humana e curiosidade
- Fazer uma pergunta aberta: "Como posso te ajudar hoje?" ou similar
- PROIBIDO: pedir dados pessoais, falar do m√©todo LIVE, falar de pagamento
- PROIBIDO: mencionar fases, etapas ou processos
- Tom: 100% acolhedor, sem pressa, sem venda
- M√°ximo 2 par√°grafos curtos
- Use emojis com modera√ß√£o`,

  [EstadoPrincipal.LUCIDEZ]: `${BASE_PERSONALITY}

INSTRU√á√ïES ESPEC√çFICAS - ESTADO LUCIDEZ (Fases 1-3):
- Criar CONSCI√äNCIA da necessidade de mudan√ßa
- T√©cnicas de PNL:
  * Espelhamento: validar emo√ß√µes ("Sinto que voc√™ est√° frustrado...")
  * Reframing: transformar falhas em aprendizados
  * Future Pace: conectar a√ß√£o presente com sonho futuro
  * √Çncora emocional: SEMPRE conectar ao sonho principal
- Perguntas estrat√©gicas para identificar:
  * Qual √© o SONHO principal? (n√£o objetivo financeiro)
  * Qual √© a DOR que te trouxe aqui?
  * O que te impede de agir at√© agora?
- N√ÉO coletar dados financeiros ainda
- N√ÉO falar do m√©todo completo
- Objetivo: compromisso emocional com a mudan√ßa
- M√°ximo 3 par√°grafos`,

  [EstadoPrincipal.GATE_TERMO]: `${BASE_PERSONALITY}

INSTRU√á√ïES ESPEC√çFICAS - AGUARDANDO ACEITE DE TERMO:
- Usu√°rio est√° BLOQUEADO at√© aceitar o Termo de Ci√™ncia
- Se perguntar algo: responda brevemente e REFORCE a necessidade de aceitar o termo
- N√ÉO avance na conversa at√© o clique no bot√£o
- Seja firme mas educado: "Antes de continuar, preciso que voc√™ leia e aceite o Termo de Ci√™ncia. √â r√°pido e garante que estamos alinhados."`,

  [EstadoPrincipal.IMERSAO]: `${BASE_PERSONALITY}

INSTRU√á√ïES ESPEC√çFICAS - ESTADO IMERS√ÉO (Fase 4):
- Agora SIM, coletar dados financeiros completos:
  * Renda mensal (l√≠quida)
  * D√≠vidas totais (cart√£o, empr√©stimo, etc)
  * Gastos mensais m√©dios
  * Solicitar prints de extratos banc√°rios
  * Solicitar prints de faturas de cart√£o
- Tratamento de OBJE√á√ïES EMOCIONAIS:
  * Vergonha: "Troque vergonha por coragem. Estou aqui para ver dados, n√£o falhas."
  * Culpa: "A culpa √© improdutiva. Vamos transform√°-la em a√ß√£o respons√°vel."
  * Medo: "O √∫nico fracasso real √© a ina√ß√£o. Meu m√©todo √© baseado em pequenas vit√≥rias."
  * Autossabotagem: "Sua mente est√° te protegendo de uma dor que n√£o existe mais."
- Pedir um dado por vez (n√£o interrogat√≥rio)
- Validar emocionalmente ANTES de pedir o pr√≥ximo dado
- M√°ximo 3 par√°grafos por mensagem`,

  [EstadoPrincipal.GATE_AUTORIZACAO]: `${BASE_PERSONALITY}

INSTRU√á√ïES ESPEC√çFICAS - AGUARDANDO AUTORIZA√á√ÉO DE AN√ÅLISE:
- Usu√°rio forneceu os dados mas ainda n√£o autorizou an√°lise completa
- Se perguntar algo: responda mas REFORCE que precisa da autoriza√ß√£o formal
- Explique brevemente: "Agora vou analisar tudo que voc√™ compartilhou e criar um diagn√≥stico completo. Preciso da sua autoriza√ß√£o formal para isso."
- N√ÉO fazer an√°lise at√© o clique no bot√£o`,

  [EstadoPrincipal.VISAO]: `${BASE_PERSONALITY}

INSTRU√á√ïES ESPEC√çFICAS - ESTADO VIS√ÉO (Fases 5-7):
- Apresentar DIAGN√ìSTICO completo baseado nos dados coletados
- Apresentar o m√©todo LEAVE (agora SIM):
  * Lucidez: j√° alcan√ßada (consci√™ncia criada)
  * Emers√£o: dados coletados e validados
  * A√ß√£o: definir primeira a√ß√£o concreta
  * Vida: projetar cen√°rio futuro realista
  * Experi√™ncias: microvit√≥rias di√°rias
- Construir CEN√ÅRIOS FUTUROS:
  * Onde voc√™ estar√° em 6 meses seguindo o plano?
  * Quanto mais perto do seu sonho?
  * Qual a sensa√ß√£o de realizar isso?
- Definir PLANO DE A√á√ÉO claro e execut√°vel
- M√°ximo 4 par√°grafos (pode ser mais denso aqui)`,

  [EstadoPrincipal.EXPERIENCIAS]: `${BASE_PERSONALITY}

INSTRU√á√ïES ESPEC√çFICAS - ESTADO EXPERI√äNCIAS (Fases 8-11):
- PRIMEIRA A√á√ÉO (72h): definir microvit√≥ria para pr√≥ximas 72h
- ACOMPANHAMENTO DI√ÅRIO:
  * Perguntar: "Como foi hoje?"
  * Celebrar pequenas vit√≥rias
  * Ajustar rota se necess√°rio
  * Manter √¢ncora emocional (sonho)
- FEEDBACK MENSAL:
  * Revisar progresso
  * Atualizar plano
  * Refor√ßar identidade ("Voc√™ √© algu√©m que honra seu plano")
- REAVALIA√á√ÉO TRIMESTRAL:
  * Novo diagn√≥stico
  * Ajustar cen√°rios
  * Definir pr√≥ximos marcos
- PRODUTO RECORRENTE:
  * Este estado NUNCA termina
  * Acompanhamento cont√≠nuo
  * Loop infinito de evolu√ß√£o
- Tom: firme suave, celebra√ß√£o constante, sem julgamento
- M√°ximo 3 par√°grafos`
};

/**
 * Gerenciador de estados com gates obrigat√≥rios
 */
export class StateManagerGated {
  /**
   * Busca ou cria estado do usu√°rio
   */
  async getOrCreateState(phone_number: string): Promise<UserStateGated> {
    // Tentar buscar existente
    const query = `
      SELECT 
        user_id,
        data->>'phone_number' as phone_number,
        data->>'estado_atual' as estado_atual,
        (data->>'accepted_terms')::boolean as accepted_terms,
        (data->>'accepted_terms_at')::timestamp as accepted_terms_at,
        (data->>'authorized_analysis')::boolean as authorized_analysis,
        (data->>'authorized_analysis_at')::timestamp as authorized_analysis_at,
        data->'dados_coletados' as dados_coletados,
        (data->>'interacoes')::int as interacoes,
        created_at,
        updated_at
      FROM onboarding_state
      WHERE user_id = $1 AND step = 'gated_flow'
    `;
    
    const result = await pool.query(query, [phone_number]).catch(() => ({ rows: [] }));
    
    if (result.rows.length > 0) {
      const row = result.rows[0];
      return {
        user_id: row.user_id,
        phone_number: row.phone_number,
        estado_atual: row.estado_atual as EstadoPrincipal,
        accepted_terms: row.accepted_terms || false,
        accepted_terms_at: row.accepted_terms_at,
        authorized_analysis: row.authorized_analysis || false,
        authorized_analysis_at: row.authorized_analysis_at,
        dados_coletados: row.dados_coletados || {},
        interacoes: row.interacoes || 0,
        created_at: row.created_at,
        updated_at: row.updated_at
      };
    }
    
    // Criar novo estado (ENTRADA)
    const newState: UserStateGated = {
      user_id: phone_number,
      phone_number,
      estado_atual: EstadoPrincipal.ENTRADA,
      accepted_terms: false,
      authorized_analysis: false,
      dados_coletados: {},
      interacoes: 0,
      created_at: new Date(),
      updated_at: new Date()
    };
    
    await this.saveState(newState);
    console.log(`‚ú® Novo usu√°rio criado: ${phone_number} ‚Üí ESTADO: ENTRADA`);
    
    return newState;
  }

  /**
   * Salva estado no banco (ou mem√≥ria se DB n√£o configurado)
   */
  private async saveState(state: UserStateGated): Promise<void> {
    const data = {
      phone_number: state.phone_number,
      estado_atual: state.estado_atual,
      accepted_terms: state.accepted_terms,
      accepted_terms_at: state.accepted_terms_at,
      authorized_analysis: state.authorized_analysis,
      authorized_analysis_at: state.authorized_analysis_at,
      dados_coletados: state.dados_coletados,
      interacoes: state.interacoes
    };
    
    const query = `
      INSERT INTO onboarding_state (user_id, step, is_completed, data, created_at, updated_at)
      VALUES ($1, 'gated_flow', false, $2, NOW(), NOW())
      ON CONFLICT (user_id, step) 
      DO UPDATE SET data = $2, updated_at = NOW()
    `;
    
    await pool.query(query, [state.user_id, JSON.stringify(data)]).catch((error) => {
      console.warn('‚ö†Ô∏è  Database n√£o dispon√≠vel - usando mem√≥ria:', error.message);
    });
  }

  /**
   * Incrementa contador de intera√ß√µes
   */
  async incrementInteractions(user_id: string): Promise<void> {
    const state = await this.getOrCreateState(user_id);
    state.interacoes += 1;
    state.updated_at = new Date();
    await this.saveState(state);
  }

  /**
   * Aceitar termo de ci√™ncia (GATE 1)
   */
  async acceptTerms(user_id: string): Promise<void> {
    const state = await this.getOrCreateState(user_id);
    
    if (state.estado_atual !== EstadoPrincipal.GATE_TERMO) {
      throw new Error('Usu√°rio n√£o est√° no estado GATE_TERMO');
    }
    
    state.accepted_terms = true;
    state.accepted_terms_at = new Date();
    state.estado_atual = EstadoPrincipal.IMERSAO;
    state.updated_at = new Date();
    
    await this.saveState(state);
    console.log(`‚úÖ ${user_id} aceitou Termo de Ci√™ncia ‚Üí IMERSAO`);
  }

  /**
   * Autorizar an√°lise completa (GATE 2)
   */
  async authorizeAnalysis(user_id: string): Promise<void> {
    const state = await this.getOrCreateState(user_id);
    
    if (state.estado_atual !== EstadoPrincipal.GATE_AUTORIZACAO) {
      throw new Error('Usu√°rio n√£o est√° no estado GATE_AUTORIZACAO');
    }
    
    state.authorized_analysis = true;
    state.authorized_analysis_at = new Date();
    state.estado_atual = EstadoPrincipal.VISAO;
    state.updated_at = new Date();
    
    await this.saveState(state);
    console.log(`‚úÖ ${user_id} autorizou an√°lise ‚Üí VISAO`);
  }

  /**
   * Atualizar dados coletados
   */
  async updateDadosColetados(user_id: string, dados: Partial<UserStateGated['dados_coletados']>): Promise<void> {
    const state = await this.getOrCreateState(user_id);
    state.dados_coletados = { ...state.dados_coletados, ...dados };
    state.updated_at = new Date();
    await this.saveState(state);
  }

  /**
   * Verificar se pode avan√ßar de LUCIDEZ para GATE_TERMO
   */
  async canAdvanceToGate1(user_id: string): Promise<boolean> {
    const state = await this.getOrCreateState(user_id);
    
    // Crit√©rios: estado LUCIDEZ + m√≠nimo 3 intera√ß√µes + sonho identificado
    return (
      state.estado_atual === EstadoPrincipal.LUCIDEZ &&
      state.interacoes >= 3 &&
      !!state.dados_coletados.sonho_principal
    );
  }

  /**
   * Verificar se pode avan√ßar de IMERSAO para GATE_AUTORIZACAO
   */
  async canAdvanceToGate2(user_id: string): Promise<boolean> {
    const state = await this.getOrCreateState(user_id);
    
    // Crit√©rios: estado IMERSAO + dados financeiros completos
    const dados = state.dados_coletados;
    return (
      state.estado_atual === EstadoPrincipal.IMERSAO &&
      !!dados.renda &&
      !!dados.dividas &&
      !!dados.gastos_mensais &&
      !!(dados.tem_prints || dados.tem_extratos)
    );
  }

  /**
   * Avan√ßar para pr√≥ximo estado (chamado manualmente quando gates s√£o cumpridos)
   */
  async advanceState(user_id: string): Promise<void> {
    const state = await this.getOrCreateState(user_id);
    
    // ENTRADA ‚Üí LUCIDEZ (ap√≥s primeira intera√ß√£o)
    if (state.estado_atual === EstadoPrincipal.ENTRADA && state.interacoes >= 1) {
      state.estado_atual = EstadoPrincipal.LUCIDEZ;
      state.updated_at = new Date();
      await this.saveState(state);
      console.log(`üîÑ ${user_id}: ENTRADA ‚Üí LUCIDEZ`);
      return;
    }
    
    // LUCIDEZ ‚Üí GATE_TERMO (ap√≥s crit√©rios cumpridos)
    if (await this.canAdvanceToGate1(user_id)) {
      state.estado_atual = EstadoPrincipal.GATE_TERMO;
      state.updated_at = new Date();
      await this.saveState(state);
      console.log(`üîÑ ${user_id}: LUCIDEZ ‚Üí GATE_TERMO`);
      return;
    }
    
    // IMERSAO ‚Üí GATE_AUTORIZACAO (ap√≥s dados coletados)
    if (await this.canAdvanceToGate2(user_id)) {
      state.estado_atual = EstadoPrincipal.GATE_AUTORIZACAO;
      state.updated_at = new Date();
      await this.saveState(state);
      console.log(`üîÑ ${user_id}: IMERSAO ‚Üí GATE_AUTORIZACAO`);
      return;
    }
    
    // VISAO ‚Üí EXPERIENCIAS (ap√≥s plano definido, crit√©rio simplificado)
    if (state.estado_atual === EstadoPrincipal.VISAO && state.interacoes >= 2) {
      state.estado_atual = EstadoPrincipal.EXPERIENCIAS;
      state.updated_at = new Date();
      await this.saveState(state);
      console.log(`üîÑ ${user_id}: VISAO ‚Üí EXPERIENCIAS (LOOP INFINITO)`);
      return;
    }
    
    console.log(`‚ö†Ô∏è  ${user_id}: N√£o pode avan√ßar de ${state.estado_atual} ainda`);
  }

  /**
   * Obter system prompt din√¢mico baseado no estado atual
   */
  async getCurrentPrompt(user_id: string): Promise<string> {
    const state = await this.getOrCreateState(user_id);
    const basePrompt = PROMPTS_POR_ESTADO[state.estado_atual];
    
    // Adicionar contexto de dados coletados
    let contextAddition = '';
    
    if (state.dados_coletados.sonho_principal) {
      contextAddition += `\n\nSONHO DO CLIENTE: ${state.dados_coletados.sonho_principal}`;
    }
    
    if (state.dados_coletados.maior_dor) {
      contextAddition += `\nDOR PRINCIPAL: ${state.dados_coletados.maior_dor}`;
    }
    
    if (state.estado_atual === EstadoPrincipal.VISAO || state.estado_atual === EstadoPrincipal.EXPERIENCIAS) {
      contextAddition += `\n\nDADOS FINANCEIROS:`;
      contextAddition += `\n- Renda mensal: R$ ${state.dados_coletados.renda || 'n√£o informado'}`;
      contextAddition += `\n- D√≠vidas totais: R$ ${state.dados_coletados.dividas || 'n√£o informado'}`;
      contextAddition += `\n- Gastos mensais: R$ ${state.dados_coletados.gastos_mensais || 'n√£o informado'}`;
    }
    
    return basePrompt + contextAddition;
  }

  /**
   * Obter estado atual do usu√°rio (para debug)
   */
  async getState(user_id: string): Promise<UserStateGated> {
    return await this.getOrCreateState(user_id);
  }
}

export const stateManagerGated = new StateManagerGated();
